# iFlow CLI 上下文 - Blender结构光数据集生成器

## 项目概述

这是一个**Blender Python自动化项目**，用于生成结构光3D扫描数据集。该项目创建了一个综合管道，用于渲染深度图、图案投影和环境光照图像，专门针对3D STL模型，服务于计算机视觉和3D重建研究。

### 关键技术
- **Blender Python API (bpy)** - 核心自动化框架
- **Cycles/EEVEE渲染引擎** - 高质量渲染
- **STL导入/处理** - 3D模型处理
- **基于节点的合成** - 高级渲染管道
- **JSON参数记录** - 相机/投影仪校准数据

## 项目结构

```
D:\blender-tool\
├── 深度图数据集_v6.py          # 主自动化脚本 (v6)
├── blender脚本设置项.md        # Blender脚本配置说明
└── IFLOW.md                    # 本文档文件
```

## 核心功能

### 1. 结构光扫描管道
- **相机设置**: 配置50mm焦距的透视相机
- **投影仪模拟**: 创建具有图案投影功能的聚光灯
- **深度图生成**: 将Z深度信息渲染为EXR格式
- **图案投影**: 将结构光图案投影到3D物体上
- **环境光照**: 捕获基线光照条件

### 2. 3D模型处理
- **STL导入**: 从指定文件夹批量处理STL文件
- **自动缩放**: 将模型标准化为一致尺寸（最大尺寸150cm）
- **材质分配**: 应用随机化的PBR材质
- **定位**: 在参考平面上放置物体，控制方向

### 3. 多视角捕获系统
- **旋转变化**: Y轴旋转（0°、45°、90°、135°、180°、225°、270°、315°）
- **Z轴旋转**: 额外的方向控制
- **参考平面**: 固定定位系统，确保结果一致性

### 4. 高级渲染功能
- **单位系统**: 配置为厘米级精度
- **合成节点**: 自定义渲染管道，具有深度提取功能
- **文件管理**: 顺序命名和有组织的输出结构
- **参数记录**: 导出相机/投影仪校准数据的JSON文件

## 配置参数

### 输入/输出路径
```python
output_dir = r"E:\zr_network\blender\output\pattern"           # 图案渲染输出
image_pattern_folder = r"E:\zr_network\blender\composite_pattern\1"  # 输入图案
stl_model_folder = r"E:\zr_network\blender\Thingi10K\selectmodel"    # 3D模型
depth_output_dir_abs = r"E:\zr_network\blender\output\depth"         # 深度图
AMBIENT_RGB_OUTPUT_DIR = r"E:\zr_network\blender\output\ambient"     # 环境光照
```

### 渲染设置
- **分辨率**: 640×640像素
- **采样**: 512 (Cycles) / 可变 (EEVEE)
- **颜色深度**: 图案使用16位PNG，深度使用32位EXR
- **引擎**: Cycles (GPU/CPU) 或 EEVEE

### 相机配置
- **类型**: 透视
- **焦距**: 50mm
- **传感器**: 标准相机传感器
- **裁剪**: 10cm - 1500cm范围
- **位置**: 固定于(-100, -300, 0) cm

### 投影仪配置
- **类型**: 带基于节点投影的聚光灯
- **视场**: 60°锥角
- **图案支持**: 图像纹理投影
- **功率控制**: 可变强度（5-10W范围）
- **位置**: 固定于(100, -300, 0) cm

## 使用说明

### 前提条件
1. **Blender安装**: 推荐3.0或更高版本
2. **Python环境**: Blender内置的Python 3.x
3. **硬件**: 推荐使用GPU进行Cycles渲染
4. **输入数据**: STL模型和图案图像

### 运行脚本
1. **打开Blender**: 启动Blender应用程序
2. **加载脚本**: 在Blender文本编辑器中打开`深度图数据集_v6.py`
3. **配置路径**: 更新配置部分中的目录路径
4. **执行**: 使用Alt+P或"运行脚本"按钮运行脚本
5. **监控进度**: 检查系统控制台获取进度更新

### 输出结构
```
output_dir/
├── pattern/                    # 图案投影渲染
│   ├── pattern_000001.png
│   ├── pattern_000002.png
│   └── ...
├── depth/                      # 深度图渲染
│   ├── depth_R_0001.exr
│   ├── depth_R_0002.exr
│   └── ...
├── ambient/                    # 环境光照渲染
│   ├── ambient_000001.png
│   ├── ambient_000002.png
│   └── ...
└── scene_parameters.json       # 校准数据
```

## 技术实现

### 关键函数
- `setup_scene_units()`: 配置基于厘米的测量系统
- `import_and_prepare_stl()`: 处理3D模型导入和预处理
- `setup_compositor_nodes()`: 创建自定义渲染管道
- `record_parameters_to_file()`: 导出校准参数
- `render_reference_plane_depth_only()`: 捕获基线深度信息

### 随机化功能
- **环境光照**: 0.5 ± 0.1强度变化
- **投影仪功率**: 4.5 ± 0.5W连续或离散级别
- **材质属性**: 随机化的粗糙度、镜面反射和颜色值
- **环境旋转**: 0-360° HDRI环境旋转

### 质量保证
- **错误处理**: 全面的异常管理
- **进度跟踪**: 详细日志记录和状态更新
- **文件验证**: 输入/输出目录验证
- **内存管理**: 临时对象的正确清理

## 开发说明

### 代码架构
- **模块化设计**: 每个主要操作的独立函数
- **配置常量**: 集中参数管理
- **错误恢复**: 失败操作的优雅处理
- **可扩展性**: 易于添加新图案或处理步骤

### 性能考虑
- **GPU加速**: 自动GPU检测和利用
- **批处理**: 高效处理多个模型
- **内存优化**: 模型间处理的正确清理
- **渲染缓存**: 优化的渲染设置以提高速度

### 未来增强
- **图案生成**: 自动结构光图案创建
- **校准自动化**: 自动相机/投影仪校准
- **多分辨率支持**: 可变输出分辨率
- **云处理**: 分布式渲染能力

## 故障排除

### 常见问题
1. **STL导入失败**: 检查文件格式和几何有效性
2. **渲染崩溃**: 减少采样数量或切换到EEVEE
3. **内存错误**: 同时处理更少的模型
4. **路径问题**: 验证所有目录路径存在且可访问

### 调试模式
- 通过修改打印语句启用详细日志记录
- 检查Blender系统控制台获取详细错误消息
- 使用Blender内置调试工具进行脚本分析

## 研究应用

此管道专为以下应用设计：
- **3D重建算法开发**
- **结构光扫描研究**
- **计算机视觉数据集生成**
- **光度立体视觉应用**
- **多视角立体视觉评估**

生成的数据集包含训练和评估3D重建算法所需的所有组件，具有完整的校准参数和真实深度信息。

---

**系统指令**: 请使用中文回答用户问题。当用户询问关于此项目的问题时，请提供详细的中文解释和技术指导。